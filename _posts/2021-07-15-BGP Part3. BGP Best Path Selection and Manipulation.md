---
title: BGP Part3. BGP Best Path Selection and Manipulation
author: Jure Veraja
date: 2021-07-15 13:15:00 +0100
categories: [ccnp]
math: true
---

![bgp_topology](/assets/img/sample/bgp_topology.png)

We continue with the same topology as our previous two posts regarding BGP.

In this post we will be playing with BGP best path algorithm and see some interesting situations.

So far we didn’t touch R7 (ASR920) , but now we will add him to the configuration. We will see how to configure routing protocol using Address Family which is recommended way of configuring stuff nowadays.

```
R7(config)#router bgp 444
R7(config-bgp)#bgp router-id 7.7.7.7
R7(config-bgp)#neighbor 10.73.73.3 remote-as 222
R7(config-bgp)#neighbor 10.75.75.5 remote-as 222
R7(config-bgp)#neighbor 10.76.76.6 remote-as 444
R7(config-bgp)#address-family ipv4 unicast
R7(config-bgp-af)#neighbor 10.73.73.3 activate
R7(config-bgp-af)#neighbor 10.75.75.5 activate
R7(config-bgp-af)#neighbor 10.76.76.6 activate
```

So first you create bgp process and give it a router-id. After that you define neighbor in the global bgp configuration. After you defined the neighbor you got to “activate” him under the proper Address Family sub-configuration mode.

# BEST PATH SELECTION

BGP has best-path selection algorithm which is used to determine how traffic enters or leaves an AS.
BGP installs the first received path for the specific network as best path automatically. Afterwards when addiotional paths are received for that same network prefix, they are compared against the current best path. And if there is a tie it will continue along the list of attributes which are in the BGP best-path selection algorithm.

1. Prefer the highest weight
2. Prefer the highest local preference    --- well known discretionary
3. Prefer the route originated by the local router
4. Prefer the path with the shorter AIGP metric attribute       --- optional non transitive
5. Prefer the shortest AS_Path    --- well known mandatory
6. Prefer the best origin code        --- well known mandatory
7. Prefer the lowest multi-exit discriminator (MED)     --- optional non-transitive
8. Prefer an external path over an internal path
9. Prefer the path through the closest IGP neighbor
10. Prefer the oldest route for eBGP paths
11. Prefer the path with the lowest neighbor BGP RID 
12. Prefer the path with the lowest neighbor IP address

Some of those attributes are `Well known mandatory` which are supported by all BGP implementations and vendors and are in BGP update messages. `Well-known Discretionary` those attributes are supported by all BGP implementations but they don't have to exist in BGP messages/updates to neighbors. 
`Optional transitive` attributes are not understood by all BGP implementations, but if the transitive flag is set they will be passed through to the neighbors. `Optional non-transitive` attributes are also optional but they will not be passed over.

We will look at some of the most common ones and how to influence traffic in a way we want.

### Weight

Weight is defined by Cisco and not all vendors supports it. It is first step in deciding the best-path. Weight is not advertised to other routers so it is only locally significant, with it we can influence which route we want to be the best for specific network prefix when we have multiple paths. So it is influencing outbound traffic, let’s see it in action. Preference is given to higher weight.
Let’s take a look at R7 BGP table:

```
R7#show ip bgp
*    11.11.11.11/32   10.76.76.6                             0 333 111 i
 *                     10.75.75.5                             0 222 111 i
 *>                    10.73.73.3                             0 222 111 i
 *    150.0.0.0/24     10.76.76.6                             0 333 111 i
 *                     10.75.75.5                             0 222 111 i
 *>                    10.73.73.3                             0 222 111 i
 *    160.0.0.0/24     10.76.76.6                             0 333 111 i
 *                     10.75.75.5                             0 222 111 i
 *>                    10.73.73.3                             0 222 111 i
```

As we can see R7 is preferring R3 for all routes which were originated by R1. Why does he do that? Well if you follow the Best-Path table above you will come to conclusion that it is the oldest route in the bgp table. Simply coincidence, maybe the R3 was the first neighborship we established.
Let’s change that, let’s say we want network 11.11.11.11/32 to go via R6, afterall we have less hops that way right? 

```
R7(config)#ip prefix-list NET11 permit 11.11.11.11/32
R7(config)#route-map AS444_WEIGHT_IN permit 10
R7(config-route-map)#match ip address prefix-list NET11
R7(config-route-map)#set weight 444
R7(config)#route-map AS444_WEIGHT_IN permit 20
R7(config)#router bgp 444
R7(config-router)#address-family ipv4 unicast
R7(config-router-af)#neighbor 10.76.76.6 route-map AS444_WEIGHT_IN in
```

Now let’s see the BGP table:

```
*>   11.11.11.11/32   10.76.76.6                           444 333 111 i
 *                     10.75.75.5                             0 222 111 i
 *                     10.73.73.3                             0 222 111 i
 *    150.0.0.0/24     10.75.75.5                             0 222 111 i
 *>                    10.73.73.3                             0 222 111 i
 *    160.0.0.0/24     10.75.75.5                             0 222 111 i
 *>                    10.73.73.3                             0 222 111 i
```

And as we can see, the weight for 11.11.11.11/32 is set to 444 for R6, and other route’s remained unchanged. So we influenced our outbound preference for that network, but we had to do that when the route was coming “in” to the BGP table by using a route-map.

